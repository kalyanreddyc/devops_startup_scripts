@Library('drilldevops-sharedlibrary@test') _
pipeline {
    agent any
    tools {
        maven "MAVEN_HOME"
    }
    environment {
        REPOSITORY = 'https://github.com/kalyanreddyc/onlinebookstoreapp.git'
        CREDENTIALS_ID = '636c6341-3a7a-491c-a744-67bf8769c54d'
    }
    stages {
        stage('Checkout') {
            steps {
                script {
                    if (!env.BRANCH_NAME) {
                        env.BRANCH_NAME = 'master' // Fallback to default branch if not specified
                    }
                    echo "Attempting to checkout branch: ${env.BRANCH_NAME}"
                    def checkedOutBranch = checkBranch_demo()
                    echo "Resolved branch for checkout: ${checkedOutBranch}"
                    gitCheckoutrepo(
                        repository: REPOSITORY,
                        credentialsId: CREDENTIALS_ID,
                        branch: checkedOutBranch
                    )
                }
            }
        }
        stage('Build and Verify') {
            steps {
                script {
                    // Call build and verify only
                    buildandPublish('verify')
                }
            }
        }
        stage('Sonar/Quality Checks') {
            steps {
                script {
                    sonarQualityChecks()
                }
            }
        }
        stage('Publish to Nexus') {
            when {
                expression {
                    // Ensure this stage runs only if SonarQube checks are successful
                    currentBuild.result == null || currentBuild.result == 'SUCCESS'
                }
            }
            steps {
                script {
                    // Now deploy to Nexus after successful Sonar checks
                    buildandPublish('deploy')
                }
            }
        }
    }
}
